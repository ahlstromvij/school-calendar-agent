name: Sonatype SCA (OSS Index)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  oss-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Sync deps (no dev)
        run: uv sync --no-dev

      - name: Export pinned deps and build OSS Index coordinates
        id: coords
        shell: bash
        run: |
          uv pip freeze > requirements.txt
          awk -F'==' 'NF==2 { printf "pkg:pypi/%s@%s\n", tolower($1), $2 }' requirements.txt > coords.txt
          echo "coordinates<<EOF" >> "$GITHUB_OUTPUT"
          cat coords.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Scan with Sonatype OSS Index
        uses: sonatype-nexus-community/ossindex-github-action@main
        with:
          coordinates: ${{ steps.coords.outputs.coordinates }}
          # auditignore: .ossindex/auditignore  # optional ignore file

